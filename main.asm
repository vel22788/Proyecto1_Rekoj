//***************************************************
;
; Universidad del Valle de Guatemala
; IE2023: Programación de Microcontroladores
; Autor: Angel Velásquez
; Descripción: Reloj Digital con funciones de reloj, fecha y alarma
; Hardware: atmega328p
; Proyecto: Reloj Digital
; Created: 13/03/2024 
;
//**************************************************


//**************************************************
; ENCABEZADO
//**************************************************
.include "M328PDEF.inc"

.DSEG    ; Sección de datos
D0_U: .BYTE 1   ; Variable que almacena el valor del D0, al editar
D0_D: .BYTE 1    ; Variable que almacena el valor del D1, al editar
D1_U: .BYTE 1    ; Variable que almacena el valor del D2, al editar
D1_D: .BYTE 1    ; Variable que almacena el valor del D3, al editar
MODO_G: .BYTE 1  ;Variable que almacena el modo en el que se encontraba antes de entrar al modo edición
CONTADOR_M3_FIJO: .BYTE 1   ;Variable que almacena el display que se va a actualizar en el modo edición
CONTADOR_SEGUNDOS: .BYTE 1  ;Variable que controla el encendido del led de segundos.
ALARMA_D0: .BYTE 1   ;Variable que almacena el primer digito de la alarma
ALARMA_D1: .BYTE 1   ;Variable que almacena el segundo digito de la alarma
ALARMA_D2: .BYTE 1   ;Variable que almacena el tercer digito de la alarma
ALARMA_D3: .BYTE 1   ;Variable que almacena el cuarto digito de la alarma
BANDERA_LEDS_CENTRO:  .BYTE 1    ;Variable que controla el encendido de las leds intermedias de los displays.

.cseg								//Indica inicio del código
.org 0x00							//Indica en que dirección va a estar el vector RESET
	JMP MAIN
.org 0x0008
    JMP ISR_PCINT1  ; Dirección para la interrupción del grupo 1 de PCINT (Puerto C)
.org 0x0012
	JMP ISR_TIMER2
.org 0x001A
	JMP ISR_TIMER1
.org 0x0020
	JMP ISR_TIMER0



MAIN:
//**************************************************
; Configuración de pila
//**************************************************
LDI R16, LOW(RAMEND)              //STACKPOINTER, PARTE BAJA
OUT SPL, R16
LDI R16, HIGH(RAMEND)             //STACKPOINTER, PARTE DE ARRIBA
OUT SPH, R16

//**************************************************
; Tabla de datos
//**************************************************
TABLA7SEG: .DB 0b0011_1111, 0b0000_0110, 0b0101_1011 , 0b0100_1111, 0b0110_0110, 0b0110_1101, 0b0111_1101, 0b0000_0111, 0b0111_1111, 0b0110_1111, 0b0111_0111, 0b0111_1100, 0b0011_1001, 0b0101_1110, 0b0111_1001, 0b0111_0001
					//0			1			2			3				4			5			6			7			8				9																		
//**************************************************
; CONFIGURACIÓN MCU
//**************************************************
SETUP:
LDI R16, 0b1000_0000		  
STS CLKPR,R16				  // Habilitar el prescaler (STS GUARDA R16 EN UN LUGAR FUERA DE I/O)
LDI R16, 0b0000_0100
STS CLKPR,R16				  // Definir el prescaler de 16 Fcpu = 1MHz

// Seteo de puertos
LDI R16, 0b0011_1111		  //PUERTO B 
OUT DDRB, R16			

LDI R16, 0b0110_0000		  //PUERTO C
OUT DDRC, R16
LDI R16, 0b0001_1111	  //PULL-UPS de los pines
OUT PORTC, R16	  

LDI R16, 0b1111_1111	  //PUERTO D
OUT DDRD, R16

//Activación de interrupciones por botón.
LDI R16, (1 << PCINT1) | (1 << PCINT0)
STS PCMSK0, R16

LDI R16, (1 << PCIE0)
STS PCICR, R16

//HABILITAR INTERRUPCIONES PARA EL PINC
CALL INIT_PCINT

// Configuración inicial de los timers
CALL INIT_T0
CALL INIT_T1
CALL INIT_T2

//Definición de la tabla con las salidas del display
LDI ZH, HIGH(TABLA7SEG <<1)
LDI ZL, LOW(TABLA7SEG <<1)

SEI			//Habilito las banderas globales

//Seteo de REGISTROS

LDI R30, 0  //R30: La hora de la alarma, esta se guarda sumando los números de los minutos y las horas (hora: 10:50 -> registro: 105)
LDI R29, 1  //R29: Mes (Unidad)
LDI R28, 0  //R28: Mes (Decena)
LDI R27, 0  //R27: Dia (Unidad)
LDI R26, 1  //R26: Dia (Decena)
LDI R25, 3  //R25: Horas (Unidad)
LDI R24, 2  //R24: Horas (Decena)
LDI R23, 9  //R23: Minutos (Unidad)
LDI R22, 5  //R22: Minutos (Decena)
LDI R21, 1  //R21: Modo en el que se encuentra (1:Hora, 2:Fecha, 3:Edición)
LDI R20, 1  //R20: Bit a editar en modo edición (0b0000_0001 -> Bit a editar)
LDI R19, 0  //R19: Bit a guardar (0-9)
LDI R18, 0  //Display a actualizar

STS ALARMA_D0, R30
STS ALARMA_D1, R30
STS ALARMA_D2, R30
STS ALARMA_D3, R30
SBI PORTB, PB1

//Definición de la tabla con las salidas del display
LDI ZH, HIGH(TABLA7SEG <<1)
LDI ZL, LOW(TABLA7SEG <<1)




//**************************************************
; LOOP INFINITO
//*************************************************

LOOP:	//LOOP INFINITO DEL PROGRAMA
RJMP LOOP


//**************************************************
; SUBRUTINAS
//**************************************************


//////////////////////////////////////////
//      init_TIMER0						//
//////////////////////////////////////////
INIT_T0:
LDI R16, (1 << CS02) | (1 << CS00)
OUT TCCR0B,  R16		// Prescaler a 1024

LDI R16, 133 //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR
OUT TCNT0, R16

LDI R16, (1 << TOIE0) //Habilitar interrupción por T0
STS TIMSK0, R16
RET

//////////////////////////////////////////
//      init_TIMER1					//
//////////////////////////////////////////
INIT_T1:

LDI R16, (1 << CS12) | (1 << CS10)
STS TCCR1B, R16

LDI R16, HIGH(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (HIGH)
STS TCNT1H, R16
LDI R16, LOW(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (LOW)
STS TCNT1L, R16

LDI R16, (1 << TOIE1) //Habilitar interrupción por T1
STS TIMSK1, R16
RET

//////////////////////////////////////////
//      init_TIMER2					//
//////////////////////////////////////////
INIT_T2:
LDI R16, (1 << CS22) | (1 << CS21) | (1 << CS20)
STS TCCR2B, R16 //Preescaler a 1024

LDI R16, 251 //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR
STS TCNT2, R16

LDI R16, (1 << TOIE2) //Habilitar interrupción por T0
STS TIMSK2, R16
RET


//////////////////////////////////////////
//      init_PCINT				//
//////////////////////////////////////////
INIT_PCINT:
    ; Habilitar las interrupciones por cambios de pin en el Puerto C (PCINT8 a PCINT12)
    LDI R16, (1 << PCIE1)  ; Habilitar las interrupciones del grupo 1 de PCINT
    STS PCICR, R16  ; Habilitar el registro de control de interrupciones por cambio de pin
    
    ; Habilitar las interrupciones en los pines específicos del Puerto C (PCINT8 a PCINT12)
    LDI R16, (1 << PCINT8) | (1 << PCINT9) | (1 << PCINT10) | (1 << PCINT11) | (1 << PCINT12)
    STS PCMSK1, R16  ; Habilitar los bits correspondientes en el registro de máscara de interrupción por cambio de pin
    RET


//////////////////////////////////////////
//      SUBRUTINA TIMER0				//
//////////////////////////////////////////
ISR_TIMER0:
ENTRAR_T0:
PUSH R16
IN R16, SREG
PUSH R16

LDI R16, 133 //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR
OUT TCNT0, R16
SBI TIFR0, TOV0 //Desactivamos la bandera de T0

CPI R21, 1
BREQ LED_S_I

CPI R21, 3
BREQ M3_MODO_I



SALIR_T0:
POP R16
OUT SREG, R16
POP R16
RETI

LED_S_I: // INTERCONEXION DE SALTOS
RJMP LED_S

M3_MODO_I: // INTERCONEXION DE SALTOS
RJMP M3_MODO

//////////////////////////////////////////////////////////
//      SUBRUTINA ENCARGADA DE LEDS DE MODOS			//
//////////////////////////////////////////////////////////

CONTROL_LED_BOTONES:
CPI R21, 1
BREQ LED_1
CPI R21, 2
BREQ LED_2
CPI R21, 4
BREQ LED_0
RET

LED_0:
CBI PORTB, PB1
CBI PORTB, PB2
RET

LED_1:
SBI PORTB, PB1
CBI PORTB, PB2
RET

LED_2:
SBI PORTB, PB2
CBI PORTB, PB1
RET


//////////////////////////////////////////
//      SUBRUTINA TIMER1				//
//////////////////////////////////////////
ISR_TIMER1:
ENTRAR_T1:
PUSH R16
IN R16, SREG
PUSH R16


LDI R16, HIGH(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (HIGH)
STS TCNT1H, R16
LDI R16, LOW(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (LOW)
STS TCNT1L, R16
SBI TIFR0, TOV1 //Desactivamos la bandera de T1

CPI R21, 3
BREQ SALIR_T1

CPI R23, 9
BREQ INC_DECE_MIN
RJMP INC_UNI_MIN

SALIR_T1:
RJMP VERIFICACION_ALARMA
SALIR_T1_F:
POP R16
OUT SREG, R16
POP R16
RETI

//////////////////////////////////////////
//      SUBRUTINA TIMER2				//
//////////////////////////////////////////
ISR_TIMER2:
ENTRAR_T2:
PUSH R16
IN R16, SREG
PUSH R16

LDI R16, 251 //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR
STS TCNT2, R16
SBI TIFR0, TOV2 //Desactivamos la bandera de T2

//Miramos en que modo estamos
CPI R21, 1
BREQ MODO_1_I
CPI R21,2
BREQ MODO_2_C
CPI R21, 3
BREQ MODO_3_D_I
CPI R21, 4
BREQ ALARMA_D_I

SALIR_T2:
POP R16
OUT SREG, R16
POP R16
RETI

ALARMA_D_I:
RJMP ALARMA_D

MODO_1_I:
RJMP MODO_1

//////////////////////////////////////////
//      SUBRUTINA BOTON					//
//////////////////////////////////////////

ISR_PCINT1:

ENTRAR:
PUSH R16
IN R16, SREG
PUSH R16

IN R16, PINC

SBRS R16, PC0
RJMP C_PC0

SBRS R16, PC1
RJMP C_PC1

SBRS R16, PC2
RJMP C_PC2

SBRS R16, PC3
RJMP C_PC3

SBRS R16, PC4
RJMP C_PC4

RJMP SALIR_BOTON

SALIR_BOTON:
SBI PCIFR, PCIF0

POP R16
OUT SREG, R16
POP R16
RETI


//////////////////////////////////////////////////////////////////////
//      SUBRUTINAS ENCARGADAS DEL CONTROL DE HORAS/MINUTOD			//
//////////////////////////////////////////////////////////////////////

//SUBRUTINA INCREMENTAR UNIDAD DE MINUTOS
INC_UNI_MIN:
INC R23
RJMP SALIR_T1

//SUBRUTINA INCREMENTAR DECENA DE MINUTOS
INC_DECE_MIN:
CPI R22, 5
BREQ INC_UNI_HORA
LDI R23, 0
INC R22
RJMP SALIR_T1

//SUBRUTINA INCREMENTAR UNIDAD DE HORAS
INC_UNI_HORA:
LDI R22, 0
LDI R23, 0

CPI R24, 2
BREQ INCREMENTAR_INTER

CPI R25, 9
BREQ INC_DECE_HORA
INC R25
RJMP SALIR_T1

INCREMENTAR_INTER:
CPI R25, 3
BREQ INC_DECE_HORA
INC R25
RJMP SALIR_T1

//SUBRUTINA INCREMENTAR DECENA DE HORAS
INC_DECE_HORA:
CPI R24, 2 //5
BREQ VALIDACION_24
INC R24
RJMP SALIR_T1

VALIDACION_24:
CPI R25, 3
BREQ RESET_HORA
INC R24
RJMP SALIR_T1

//SUBRUTINA REINICIAR RELOJ
RESET_HORA:
LDI R24, 0
LDI R25, 0
RJMP ACTUA_DIA

MODO_2_C:
RJMP MODO_2

MODO_3_D_I:
RJMP MODO_3_D

M3A_ACTIVO_I:
RJMP M3A_ACTIVO

M3B_ACTIVO_I:
RJMP M3B_ACTIVO

M3C_ACTIVO_I:
RJMP M3C_ACTIVO

M3_MODO:
LDS R16, MODO_G
CPI R16, 1
BREQ M3A_ACTIVO_I
CPI R16, 2
BREQ M3B_ACTIVO_I
CPI R16, 4
BREQ M3C_ACTIVO_I


////////////////////////////////////////////
//////          MODO 1				///////
//////////////////////////////////////////
MODO_1:
M1_0:
CPI R18, 0
BREQ D0
RJMP M1_1

M1_1:
CPI R18, 1
BREQ D1
RJMP M1_2

M1_2:
CPI R18, 2
BREQ D2
RJMP M1_3

M1_3:
CPI R18, 3
BREQ D3
LDI R18, 0
RJMP SALIR_T2

PRENDER_LEDS_CENTRO:
ORI R16, (1 << 7)
RET
APAGAR_LEDS_CENTRO:
ANDI R16, ~(1 << 7)
RET

LEDS_CENTRO_CONTROL:
LDS R17, BANDERA_LEDS_CENTRO
CPI R17, 1
BREQ PRENDER_LEDS_CENTRO
CPI R17, 0
BREQ APAGAR_LEDS_CENTRO
RET

D0:

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R23
LPM R16, Z
SBC ZL, R23

OUT PORTD, R16


INC R18

RJMP SALIR_T2

D1:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R22
LPM R16, Z
SBC ZL, R22

CALL LEDS_CENTRO_CONTROL

SEGUIR_D1_B:
OUT PORTD, R16

INC R18

RJMP SALIR_T2

D2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R25
LPM R16, Z
SBC ZL, R25

CALL LEDS_CENTRO_CONTROL

OUT PORTD, R16

INC R18

RJMP SALIR_T2


D3:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R24
LPM R16, Z
SBC ZL, R24

OUT PORTD, R16

LDI R18, 0

RJMP SALIR_T2

////////////////////////////////////////////
//////          MODO 2				///////
//////////////////////////////////////////
MODO_2:
M2_0:
CPI R18, 0
BREQ D0_2
RJMP M2_1

M2_1:
CPI R18, 1
BREQ D1_2
RJMP M2_2

M2_2:
CPI R18, 2
BREQ D2_2
RJMP M2_3

M2_3:
CPI R18, 3
BREQ D3_2
LDI R18, 0
RJMP SALIR_T2

D0_2:

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R29
LPM R16, Z
SBC ZL, R29

OUT PORTD, R16


INC R18

RJMP SALIR_T2

D1_2:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R28
LPM R16, Z
SBC ZL, R28

OUT PORTD, R16

INC R18

RJMP SALIR_T2

D2_2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R27
LPM R16, Z
SBC ZL, R27

OUT PORTD, R16

INC R18

RJMP SALIR_T2


D3_2:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R26
LPM R16, Z
SBC ZL, R26

OUT PORTD, R16

LDI R18, 0

RJMP SALIR_T2

/////////////////////////////////////////////////////////////////////////////7
//Incrementar días/mes
ACTUA_DIA:
MOV R16, R28
LSL R16
LSL R16
ADD R16, R28
LSL R16
ADC R16, R29

CPI R16, 1
BRNE FEBRERO
LDI R16, 31 //Días de ENERO

FEBRERO:
CPI R16, 2
BRNE MARZO
LDI R16, 28 //Días de FEBRERO

MARZO:
CPI R16, 3
BRNE ABRIL
LDI R16, 31 //Días de MARZO

ABRIL:
CPI R16, 4
BRNE MAYO
LDI R16, 30 //Días de ABRIL

MAYO:
CPI R16, 5
BRNE JUNIO
LDI R16, 31 //Días de MAYO

JUNIO:
CPI R16, 6
BRNE JULIO
LDI R16, 30 //Días de JUNIO

JULIO:
CPI R16, 7
BRNE AGOSTO
LDI R16, 31 //Días de JULIO

AGOSTO:
CPI R16, 8
BRNE SEPTIEMBRE
LDI R16, 31 //Días de AGOSTO

SEPTIEMBRE:
CPI R16, 9
BRNE OCTUBRE
LDI R16, 30 //Días de SEPTIEMBRE

OCTUBRE:
CPI R16, 10
BRNE NOVIEMBRE
LDI R16, 31 //Días de OCTUBRE

NOVIEMBRE:
CPI R16, 11
BRNE DICIEMBRE
LDI R16, 30 //Días de NOVIEMBRE

DICIEMBRE:
CPI R16, 12
BRNE DIAS_CONTI
LDI R16, 31 //Días de DICIEMBRE


DIAS_CONTI:
MOV R17, R26
LSL R17
LSL R17
ADD R17, R26
LSL R17
ADC R17, R27

CP R16, R17

BREQ INC_MES
CPI R27, 9
BREQ INC_DEC
INC R27
RJMP SALIR_T1

INC_DEC:
LDI R27, 0
INC R26
RJMP SALIR_T1

INC_MES:
LDI R26, 0
LDI R27, 0
MOV R16, R28
LSL R16
LSL R16
ADD R16, R28
LSL R16
ADC R16, R29

CPI R16, 12
BREQ MES_RESET
CPI R29, 9
BREQ MES_DEC_INC
INC R29
RJMP SALIR_T1

MES_DEC_INC:
LDI R29, 0
INC R28
RJMP SALIR_T1

MES_RESET:
LDI R28, 0
LDI R29, 1
RJMP SALIR_T1

////////////////////////////////////////////
//////          MODO 3				///////
//////////////////////////////////////////
C_PC0: //Subrutinas encargadas del botón 1
CPI R21, 3
BRNE MODO_3
RJMP MODO_3_F

MODO_3_F:
LDS R21, MODO_G

MODO_3_F_G:
LDS R16, MODO_G
CPI R16, 1
BREQ GUARDAR_M1
CPI R16, 2
BREQ GUARDAR_M2
CPI R16, 4
BREQ GUARDAR_M4

GUARDAR_M4:
LDS R16, D0_U
STS ALARMA_D0, R16
LDS R16, D0_D
STS ALARMA_D1, R16
LDS R16, D1_U
STS ALARMA_D2, R16
LDS R16, D0_D
STS ALARMA_D3, R16
RJMP SALIR_BOTON


GUARDAR_M1:
LDS R23, D0_U
LDS R22, D0_D
LDS R25, D1_U
LDS R24, D1_D
//reseteo de los relojes
//T1
LDI R16, HIGH(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (HIGH)
STS TCNT1H, R16
LDI R16, LOW(6942) //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR (LOW)
STS TCNT1L, R16
//T0
LDI R16, 133 //CARGO EL VALOR DONDE DEBERIA EMPEZAR A CONTAR
OUT TCNT0, R16

RJMP SALIR_BOTON

GUARDAR_BIT3_DES_I:
RJMP GUARDAR_BIT3_DES

GUARDAR_M2:
LDS R29, D0_U
LDS R28, D0_D
LDS R27, D1_U
LDS R26, D1_D
RJMP SALIR_BOTON

MODO_3:
CPI R21, 1
BREQ GUARDAR_VARIABLES_1
CPI R21, 2
BREQ GUARDAR_VARIABLES_2
CPI R21,4
BREQ GUARDAR_VARIABLES_4

GUARDAR_VARIABLES_4:
LDS R17, ALARMA_D0
STS D0_U, R17
LDS R17, ALARMA_D1
STS D0_D, R17
LDS R17, ALARMA_D2
STS D1_U, R17
LDS R17, ALARMA_D3
STS D1_D, R17
RJMP GUARDAR_VARIABLES_FIN

GUARDAR_VARIABLES_1:
STS D0_U, R23
STS D0_D, R22
STS D1_U, R25
STS D1_D, R24
RJMP GUARDAR_VARIABLES_FIN

GUARDAR_VARIABLES_2:
STS D0_U, R29
STS D0_D, R28
STS D1_U, R27
STS D1_D, R26
RJMP GUARDAR_VARIABLES_FIN

GUARDAR_VARIABLES_FIN:

STS MODO_G, R21
LDI R21, 3
RJMP SALIR_BOTON

C_PC1: //Subrutinas encargadas del botón 2
CPI R21, 1
BREQ C_FECHA
CPI R21, 2
BREQ C_HORA
CPI R21, 3
BREQ BIT_IZQ

RJMP SALIR_BOTON

C_FECHA:
LDI R21, 2
CALL CONTROL_LED_BOTONES
RJMP SALIR_BOTON

SALIR_BOTON_INTER:
RJMP SALIR_BOTON

C_HORA:
LDI R21, 1
CALL CONTROL_LED_BOTONES
RJMP SALIR_BOTON

BIT_IZQ:
CALL GUARDAR_DES
CPI R20, 0b0000_1000
BREQ BIT_IZQ_R
LDI R19, 0
LSL R20
RJMP SALIR_BOTON
BIT_IZQ_R:
LDI R19, 0
LDI R20, 0b0000_0001
RJMP SALIR_BOTON

ALARMA_I:
RJMP ALARMA
SALIR_ALARMA_I:
RJMP SALIR_ALARMA

SALIR_ALARMA:
LDI R21, 1
CALL CONTROL_LED_BOTONES
RJMP SALIR_BOTON

C_PC2:	//Subrutinas encargadas del botón 3
CPI R21, 1
BREQ ALARMA_I
CPI R21, 3
BREQ BIT_DER
CPI R21, 4
BREQ SALIR_ALARMA_I
RJMP SALIR_BOTON_INTER

BIT_DER:
CALL GUARDAR_DES
CPI R20, 0b0000_0001
BREQ BIT_DER_R
LDI R19, 0
LSR R20
RJMP SALIR_BOTON
BIT_DER_R:
LDI R19, 0
LDI R20, 0b0000_1000
RJMP SALIR_BOTON_INTER

GUARDAR_DES:
CPI R20, 0b0000_0001
BREQ GUARDAR_BIT0_DES
CPI R20, 0b0000_0010
BREQ GUARDAR_BIT1_DES
CPI R20, 0b0000_0100
BREQ GUARDAR_BIT2_DES
CPI R20, 0b0000_1000
BREQ GUARDAR_BIT3_DES

GUARDAR_BIT0_DES:
STS D0_U, R19
RET

GUARDAR_BIT1_DES:
STS D0_D,R19
RET

GUARDAR_BIT2_DES:
STS  D1_U,R19
RET

GUARDAR_BIT3_DES:
STS D1_D, R19
RET

C_PC3:	//Subrutinas encargadas del botón 4
CPI R21, 3
BRNE SALIR_BOTON_INTER

CPI R19, 9
BREQ BIT_A_C
INC R19
RJMP SALIR_BOTON

BIT_A_C:
LDI R19, 0
RJMP SALIR_BOTON_INTER


SALIR_BOTON_INTER_I:
RJMP SALIR_BOTON_INTER

C_PC4:
CPI R21, 3
BRNE SALIR_BOTON_INTER_I

CPI R19, 0
BREQ BIT_D_C
DEC R19
RJMP SALIR_BOTON_INTER

BIT_D_C:
LDI R19, 9
RJMP SALIR_BOTON_INTER

MODO_3B_D0_I:
RJMP MODO_3B_D0

MODO_3B_D1_I:
RJMP MODO_3B_D1

MODO_3B_D2_I:
RJMP MODO_3B_D2

MODO_3B_D3_I:
RJMP MODO_3B_D3

//////////////////////////////////
MODO_3_D:

LDS R16, CONTADOR_M3_FIJO

LDS R17, MODO_G
CPI R17, 1
BREQ M1_3DIS
CPI R17, 2
BREQ M2_3DIS
CPI R17, 4
BREQ M4_DIS_I

M4_DIS_I:
RJMP M4_3DIS

M1_3DIS:
CPI R20, 0b0000_0001
BREQ MODO_3_D0
CPI R20, 0b0000_0010
BREQ MODO_3_D1
CPI R20, 0b0000_0100
BREQ MODO_3_D2
CPI R20, 0b0000_1000
BREQ MODO_3_D3
RJMP SALIR_T2

M2_3DIS:
CPI R20, 0b0000_0001
BREQ MODO_3B_D0_I
CPI R20, 0b0000_0010
BREQ MODO_3B_D1_I
CPI R20, 0b0000_0100
BREQ MODO_3B_D2_I
CPI R20, 0b0000_1000
BREQ MODO_3B_D3_I
RJMP SALIR_T2

MODO_3_D0:

M3A_1:
CPI R16, 0
BREQ M3A_D1
RJMP M3A_2

M3A_2:
CPI R16, 1
BREQ M3A_D2_I
RJMP M3A_3_I

M3A_3:
CPI R16, 2
BREQ M3A_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

MODO_3_D1:
M3A_0_D1:
CPI R16, 0
BREQ M3A_D0
RJMP M3A_2_D1

M3A_2_D1:
CPI R16, 1
BREQ M3A_D2
RJMP M3A_3_D1

M3A_3_D1:
CPI R16, 2
BREQ M3A_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3A_3_I:
RJMP M3A_3

MODO_3_D2:
M3A_0_D2:
CPI R16, 0
BREQ M3A_D0
RJMP M3A_1_D2

M3A_1_D2:
CPI R16, 1
BREQ M3A_D1
RJMP M3A_3_D2

M3A_3_D2:
CPI R16, 2
BREQ M3A_D3

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

MODO_3_D3:
M3A_0_D3:
CPI R16, 0
BREQ M3A_D0
RJMP M3A_1_D3

M3A_D3_I:
RJMP M3A_D3

M3A_1_D3:
CPI R16, 1
BREQ M3A_D1
RJMP M3A_2_D3

M3A_2_D3:
CPI R16, 2
BREQ M3A_D2

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3A_D2_I:
RJMP M3A_D2

M3A_D0:

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R23
LPM R16, Z
SBC ZL, R23

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3A_D1:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R22
LPM R16, Z
SBC ZL, R22

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3A_D2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R25
LPM R16, Z
SBC ZL, R25

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2


M3A_D3:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R24
LPM R16, Z
SBC ZL, R24

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

/////////////////////////////////////////////////////////////////////////////
M3A_ACTIVO:

LDS R23, D0_U
LDS R22, D0_D
LDS R25, D1_U
LDS R24, D1_D

CPI R20, 0b0000_0001
BREQ M3A_D0_ACT
CPI R20, 0b0000_0010
BREQ M3A_D1_ACT
CPI R20, 0b0000_0100
BREQ M3A_D2_ACT
CPI R20, 0b0000_1000
BREQ M3A_D3_ACT


M3A_D0_ACT:

CALL GUARDAR_BIT0_DES

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3A_D1_ACT:
CALL GUARDAR_BIT1_DES

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3A_D2_ACT:
CALL GUARDAR_BIT2_DES

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0


M3A_D3_ACT:
CALL GUARDAR_BIT3_DES

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

/////////////////////////////////////////////////////////////////
M3B_ACTIVO:

LDS R29, D0_U
LDS R28, D0_D
LDS R27, D1_U
LDS R26, D1_D

CPI R20, 0b0000_0001
BREQ M3B_D0_ACT
CPI R20, 0b0000_0010
BREQ M3B_D1_ACT
CPI R20, 0b0000_0100
BREQ M3B_D2_ACT
CPI R20, 0b0000_1000
BREQ M3B_D3_ACT


M3B_D0_ACT:

CALL GUARDAR_BIT0_DES

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3B_D1_ACT:
CALL GUARDAR_BIT1_DES

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3B_D2_ACT:
CALL GUARDAR_BIT2_DES

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0


M3B_D3_ACT:
CALL GUARDAR_BIT3_DES

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

//////////////////////////////////////////////////////////////////////////
MODO_3B_D0:

M3B_1:
CPI R16, 0
BREQ M3B_D1
RJMP M3B_2

M3B_2:
CPI R16, 1
BREQ M3B_D2_I
RJMP M3B_3_I

M3B_3:
CPI R16, 2
BREQ M3B_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

MODO_3B_D1:
M3B_0_D1:
CPI R16, 0
BREQ M3B_D0
RJMP M3B_2_D1

M3B_2_D1:
CPI R16, 1
BREQ M3B_D2
RJMP M3B_3_D1

M3B_3_D1:
CPI R16, 2
BREQ M3B_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3B_3_I:
RJMP M3B_3

MODO_3B_D2:
M3B_0_D2:
CPI R16, 0
BREQ M3B_D0
RJMP M3B_1_D2

M3B_1_D2:
CPI R16, 1
BREQ M3B_D1
RJMP M3B_3_D2

M3B_3_D2:
CPI R16, 2
BREQ M3B_D3

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

MODO_3B_D3:
M3B_0_D3:
CPI R16, 0
BREQ M3B_D0
RJMP M3B_1_D3

M3B_D3_I:
RJMP M3B_D3

M3B_1_D3:
CPI R16, 1
BREQ M3B_D1
RJMP M3B_2_D3

M3B_2_D3:
CPI R16, 2
BREQ M3B_D2

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3B_D2_I:
RJMP M3B_D2

M3B_D0:

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R29
LPM R16, Z
SBC ZL, R29

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3B_D1:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R28
LPM R16, Z
SBC ZL, R28

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3B_D2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R27
LPM R16, Z
SBC ZL, R27

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2


M3B_D3:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R26
LPM R16, Z
SBC ZL, R26

OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

LED_S:
LDS R16, CONTADOR_SEGUNDOS
CPI R16, 4
BREQ LEDS_CENTRO
CPI R16, 8
BREQ LED_SEGUNDOS

INC R16
STS CONTADOR_SEGUNDOS, R16
RJMP SALIR_T0

APAGAR_BANDERA_LEDS:
LDI R17, 0
STS BANDERA_LEDS_CENTRO, R17
RJMP SEGUIR_LEDS
ENCENDER_BANDERA_LEDS:
LDI R17, 1
STS BANDERA_LEDS_CENTRO, R17
RJMP SEGUIR_LEDS

LEDS_CENTRO:
LDS R17, BANDERA_LEDS_CENTRO
CPI R17, 1
BREQ APAGAR_BANDERA_LEDS
CPI R17, 0
BREQ ENCENDER_BANDERA_LEDS

SEGUIR_LEDS:

SBI PORTB, PB4
SBI PORTB, PB5
SBI PORTD, PD7

CBI PORTB, PB0
SBI PORTC, PC6

INC R16
STS CONTADOR_SEGUNDOS, R16

RJMP SALIR_T0

LED_SEGUNDOS:
LDI R16, 0
STS CONTADOR_SEGUNDOS, R16
SBI PORTB, PB0
CBI PORTC, PC6

RJMP SALIR_T0

/////////////////////////////////////////////////////////////
//////////		ALARMA					////////////////////
/////////////////////////////////////////////////////////////
ALARMA:
LDI R21, 4
CALL CONTROL_LED_BOTONES
RJMP SALIR_BOTON_INTER

ALARMA_D:
M4_0:
CPI R18, 0
BREQ M4_D0
RJMP M4_1

M4_1:
CPI R18, 1
BREQ M4_D1
RJMP M4_2

M4_2:
CPI R18, 2
BREQ M4_D2
RJMP M4_3

M4_3:
CPI R18, 3
BREQ M4_D3
LDI R18, 0
RJMP SALIR_T2

M4_D0:
SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

LDS R17, ALARMA_D0

ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16


INC R18

RJMP SALIR_T2

M4_D1:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

LDS R17, ALARMA_D1

ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16

INC R18
RJMP SALIR_T2

M4_D2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


LDS R17, ALARMA_D2

ADD ZL, R17
LPM R16, Z
SBC ZL, R17

OUT PORTD, R16

INC R18
RJMP SALIR_T2


M4_D3:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

LDS R17, ALARMA_D3
ADD ZL, R17
LPM R16, Z
SBC ZL, R17

OUT PORTD, R16

LDI R18, 0

RJMP SALIR_T2

M4_3DIS:
CPI R20, 0b0000_0001
BREQ MODO_3C_D0
CPI R20, 0b0000_0010
BREQ MODO_3C_D1
CPI R20, 0b0000_0100
BREQ MODO_3C_D2
CPI R20, 0b0000_1000
BREQ MODO_3C_D3
RJMP SALIR_T2

M3C_D1_I:
RJMP M3C_D1

MODO_3C_D0:

M3C_1:
CPI R16, 0
BREQ M3C_D1_I
RJMP M3C_2

M3C_2:
CPI R16, 1
BREQ M3C_D2_I
RJMP M3C_3_I

M3C_3:
CPI R16, 2
BREQ M3C_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3C_D0_I:
RJMP M3C_D0

MODO_3C_D1:
M3C_0_D1:
CPI R16, 0
BREQ M3C_D0_I
RJMP M3C_2_D1

M3C_D2_I:
RJMP M3C_D2

M3C_2_D1:
CPI R16, 1
BREQ M3C_D2_I
RJMP M3C_3_D1

M3C_3_D1:
CPI R16, 2
BREQ M3C_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3C_3_I:
RJMP M3C_3

MODO_3C_D2:
M3C_0_D2:
CPI R16, 0
BREQ M3C_D0
RJMP M3C_1_D2

M3C_D1_I2:
RJMP M3C_D1

M3C_1_D2:
CPI R16, 1
BREQ M3C_D1_I
RJMP M3C_3_D2

M3C_3_D2:
CPI R16, 2
BREQ M3C_D3_I

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

MODO_3C_D3:
M3C_0_D3:
CPI R16, 0
BREQ M3C_D0
RJMP M3C_1_D3

M3C_D3_I:
RJMP M3C_D3

M3C_1_D3:
CPI R16, 1
BREQ M3C_D1
RJMP M3C_2_D3

M3C_2_D3:
CPI R16, 2
BREQ M3C_D2

LDI R16, 0
STS CONTADOR_M3_FIJO, R16
RJMP SALIR_T2

M3C_D2_I2:
RJMP M3C_D2

M3C_D0:

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

LDS R17, ALARMA_D0
ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16


LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3C_D1:

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

LDS R17, ALARMA_D1

ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16


LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2

M3C_D2:

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


LDS R17, ALARMA_D2

ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2


M3C_D3:

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

LDS R17, ALARMA_D3

ADD ZL, R17
LPM R16, Z
SBC ZL, R17
OUT PORTD, R16

LDS R16, CONTADOR_M3_FIJO
INC R16
STS CONTADOR_M3_FIJO, R16

RJMP SALIR_T2




M3C_ACTIVO:


LDS R16, D0_U
STS ALARMA_D0, R16

LDS R16, D0_D
STS ALARMA_D1, R16

LDS R16, D1_U
STS ALARMA_D2, R16

LDS R16, D1_D
STS ALARMA_D3, R16

CPI R20, 0b0000_0001
BREQ M3C_D0_ACT
CPI R20, 0b0000_0010
BREQ M3C_D1_ACT
CPI R20, 0b0000_0100
BREQ M3C_D2_ACT
CPI R20, 0b0000_1000
BREQ M3C_D3_ACT


M3C_D0_ACT:

CALL GUARDAR_BIT0_DES

SBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3C_D1_ACT:
CALL GUARDAR_BIT1_DES

CBI PORTB, PB3
SBI PORTB, PB4
CBI PORTB, PB5
CBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

M3C_D2_ACT:
CALL GUARDAR_BIT2_DES

CBI PORTB, PB3
CBI PORTB, PB4
SBI PORTB, PB5
CBI PORTC, PC5


ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0


M3C_D3_ACT:
CALL GUARDAR_BIT3_DES

CBI PORTB, PB3
CBI PORTB, PB4
CBI PORTB, PB5
SBI PORTC, PC5

ADD ZL, R19
LPM R16, Z
SBC ZL, R19

OUT PORTD, R16
RJMP SALIR_T0

VERIFICACION_ALARMA:
VAL1:
LDS R16, ALARMA_D0
CP R16, R23
BREQ VAL2
RJMP SALIR_T1_F

VAL2:
LDS R16, ALARMA_D1
CP R16, R22
BREQ VAL3
RJMP SALIR_T1_F

VAL3:
LDS R16, ALARMA_D2
CP R16, R25
BREQ VAL4
RJMP SALIR_T1_F

VAL4:
LDS R16, ALARMA_D3
CP R16, R24
BREQ PRENDER_ALARMA
RJMP SALIR_T1_F

PRENDER_ALARMA:
SBI PORTB, PB1
SBI PORTB, PB2
RJMP SALIR_T1_F

APAGAR_ALARMA:
CALL CONTROL_LED_BOTONES
RJMP SALIR_T1_F